---
title: "Programación en R para el análisis de la calidad del aire"
author: "(c) Dr. Jair Carrillo"
date: "08-12-2024"
date-format: full
lang: es
format:
  revealjs:
    theme: night
    chalkboard: true
    footer: "Reunión anual: Red Delfin de Contaminación Atmosférica"
    code-block-height: 450px
editor: visual
---

```{r}
#| echo: false

library(pacman)
p_load(tidyverse,
       openair,
       openairmaps,
       gt,shiny)
```




# Semblanza {style="font-size: 0.8em; text-align:justify"}

:::incremental
- Investigación: "Efecto de micropartículas de carbonato de calcio y dióxido de silicio presentes en el material particulado fino del área metropolitana de Monterrey, en la compresibilidad del surfactante pulmonar"


- Supervisor de calidad en la Secretaría de Medio Ambiente del Estado de Nuevo León

![](main_presentation_files/figure-presentation/sima.jpg){.absolute top=270 left=900 width="200" height="150"}


- Consultor ambiental 

![](main_presentation_files/figure-presentation/consultoria.jpg){.absolute top=500 left=900 width="100" height="150"}
:::

# Introducción

# ¿ Que es r y Rstudio? {style="font-size: 0.8em; text-align:justify"}

r es un software gratuito y con un ambiente para generar **computación estadística** y **gráficas de alto nivel**. Las principales características que posee este software son:

::: incremental
-   Orientado a objetos
-   Colección de funciones enfocadas en temas específicos (Paquetes)
-   Repositorio CRAN (+10,000 paquetes) y de la comunidad
-   Paquetes respaldados por la comunidad de R
:::

![](main_presentation_files/figure-presentation/r_logo.png){.absolute top=500 left=450 width="100" height="100"}


::: notes
Los paquetes son un conjunto de funciones que han sido revisadas por la comunidad y el CRAN, dandole una mayor confiabilidad al paquete que se encuentra en CRAN, en el caso de los paquetes hechos por la comunidad no se tiene la certeza de tener un mantenimiento constante o en su defecto, si las funciones son correctas. 
:::
--- 

# {style="font-size: 0.8em; text-align:justify"}

Rstudio (Posit) es una IDE que permite desarrollar códigos del software r, haciendo más sencillo su uso. A partir de 2023, se puede correr códigos del software python, haciendo más dinámico emplear ambos tipos de software para extraer información, ordenarla, aplicar diversos análisis estadísticos, visuliazarlos y compartirlos.

![](main_presentation_files/figure-presentation/Rstudio-Logo-Flat.png){.absolute top=400 left=600 width="250" height="90"}

## Openair y Openairmaps {style="font-size: 0.8em; text-align:justify"}

Paqueterías especializadas en el tratamiento de información referente a contaminación atmosférica. Diseñados por el Dr. David Carslaw de la universidad de York en Inglaterra. 

- Openair: Conjunto de funciones que permiten limpiar, ordenar y visualizar diversos conjuntos de datos sobre calidad del aire. 

![](main_presentation_files/figure-presentation/logo.png){.absolute top=450 left=450 width="200" height="200"}

---

# {style="font-size: 0.8em; text-align:justify"}

- Openairmaps: Conjunto de funciones que permiten visualizar espacialmente diversos conjuntos de datos enfocados en datos meteorológicos y de calidad del aire.

![](main_presentation_files/figure-presentation/openairmaps.png){.absolute top=400 left=450 width="190" height="200"}

# Caso de Estudio

## Red Autómatica de Monitoreo Atmósferico (RAMA) {style="font-size: 0.8em; text-align:justify"}

Se extiende a lo largo del valle del México, teniendo 32 estaciones de monitoreo entre la ciudad de México y Estado de México. Está red es de las más extensas y la primera en operar en México (1986) la cual dio paso a los procedimientos y leyes en materia de contaminación atmosférica y control de emisiones. Actualmente mide las concentraciones de los contaminantes criterio:

::: Incremental
-PM~10~

-PM~2.5~

-O~3~

-SO~2~

-NO~2~

-CO
:::

La información es compartida atraves de su página: aire.cdmx.gob.mx y en el portal de datos abiertos de la ciudad de México, además del Sistema Nacional de Información de la Calidad del Aire (SINAICA).

## Adquisición de Datos {style="font-size: 0.8em; text-align:justify"}

La información de esta presentación fue adquirida mediante solicitud de Transparencia en la cual se obtuvo datos de la RAMA para los años 2021-2022. 

```{.r code-line-numbers="|1|4-5|8-12|13-16|17-21|22-24|25-29|30-31|34|37-44|47|50"}
dl_station_pol <- function(anio_inicio, anio_fin, my_station, my_pol) {
  
  # Asegurarse de que los años se manejen correctamente como números
  anio_inicio <- as.numeric(anio_inicio)
  anio_fin <- as.numeric(anio_fin)
  
  # Filtrar y manipular los datos
  x <- table_data_list |> 
    filter(
      SMCA == my_station,
      parametro == my_pol
    ) |> 
    mutate(
      date = ymd_h(paste(fecha, hora)),
      year_date = year(date)
    ) |> 
    rename(
      concentracion = valorAct,
      clave_estacion = 'Clave de la estación',
      nombre_estacion = 'Nombre de la estación'
    ) |>
    filter(
      year_date >= anio_inicio & year_date <= anio_fin
    ) |>  
    select(
      -c(file_path, nivelValidacion, 'Red de monitoreo', 
         year_date,fecha, hora,O3, CO, SO2, NO2, PM2.5, 
         PM10, VV, DV, TMP,HR, PP, RS)
    ) |> 
    left_join(coord_station_sinaica) |> 
    select(-c(alt,obs_estac,SMCA,Municipio))
  
  # Formatear la columna date
  x$date <- format(x$date, "%Y-%m-%d %H:%M:%S")
  
  # Escribir el resultado en un archivo CSV
  write.csv(
    x,
    file = paste0(
      getwd(), "/main_presentation_files/database-presentation/cdmx/data_", 
      my_pol, "_", my_station, "_", anio_inicio, "_to_", anio_fin, ".csv"
    ),
    fileEncoding = "latin1"
  )
  
  # Devolver el data frame filtrado y manipulado
  return(x)
}

dl_station_pol(2022,2022,"Ciudad de México","PM10")

```


## Análisis Exploratorio de los Datos (EDA) {style="font-size: 0.8em; text-align:justify"}

```{r}
source("clean_script.R")
```

```{r}
#| echo: false
#| output-location: slide
station_calendar_plot("PM10")
```


## Ejemplo

```{r}
#| echo: false
#| output-location: slide
library(ggplot2)
ggplot(airquality, aes(Temp, Ozone)) + 
  geom_point() + 
  geom_smooth(method = "loess")
  
```





